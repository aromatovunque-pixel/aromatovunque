<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Aromat Game!</title>
  <style>
    :root{
      --bg:#0b0f16;
      --panel:#0f1724;
      --panel2:#101b2a;
      --txt:#eaf2ff;
      --muted:#9bb0c9;
      --y:#f2e300; /* Aromat-ish */
      --g:#2f7f2f;
      --r:#c60018;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 20%, #18223a 0%, var(--bg) 55%, #05070c 100%); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #wrap{height:100%;display:flex;flex-direction:column}
    header{
      padding:10px 12px 6px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .title{
      display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;
    }
    .pixel{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      letter-spacing:1px;
      font-weight:900;
      font-size:22px;
      text-transform:uppercase;
      color:var(--y);
      text-shadow:
        0 0 8px rgba(242,227,0,.35),
        0 0 18px rgba(242,227,0,.18);
    }
    .sub{color:var(--muted);font-size:12px}
    .controls{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end
    }
    button, .chip{
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      color:var(--txt);
      padding:8px 10px;
      border-radius:12px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    button:active{transform:translateY(1px)}
    .chip{cursor:default}
    .btn-yellow{border-color:rgba(242,227,0,.35)}
    .btn-audio{
      border-color:rgba(47,127,47,.4);
    }
    .btn-audio.off{
      border-color:rgba(198,0,24,.45);
      background:linear-gradient(180deg, rgba(198,0,24,.18), rgba(198,0,24,.08));
    }

    main{flex:1;display:flex;align-items:center;justify-content:center;padding:10px}
    .frame{
      width:min(980px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:10px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      position:relative;
    }
    #hud{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      padding:8px 8px 10px;
      flex-wrap:wrap;
    }
    #hud .left, #hud .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #hud .stat{
      padding:8px 10px;border-radius:12px;
      background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.12));
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;
    }
    #hud .stat b{color:#fff}
    canvas{
      width:100%;
      height:auto;
      aspect-ratio: 16 / 9;
      background:linear-gradient(180deg, rgba(18,28,45,.5), rgba(8,12,20,.65));
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      display:block;
      touch-action:none;
    }

    /* Overlay screens */
    #overlay{
      position:absolute;inset:10px;
      display:flex;align-items:center;justify-content:center;
      pointer-events:none;
    }
    .panel{
      width:min(560px, 92%);
      background:linear-gradient(180deg, rgba(15,23,36,.92), rgba(10,16,26,.92));
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:16px;
      box-shadow:0 20px 70px rgba(0,0,0,.6);
      pointer-events:auto;
    }
    .panel h2{margin:0 0 6px;font-size:18px}
    .panel p{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1}
    .big{
      padding:10px 12px;font-size:13px;border-radius:14px;
      border-color:rgba(242,227,0,.35);
    }
    .danger{
      border-color:rgba(198,0,24,.45);
      background:linear-gradient(180deg, rgba(198,0,24,.18), rgba(198,0,24,.08));
    }
    .hint{margin-top:10px;font-size:12px;color:rgba(155,176,201,.9)}
    .hidden{display:none !important}

    /* Touch controls (mobile) */
    #touchUI{
      position:absolute;inset:auto 12px 12px 12px;
      display:flex;justify-content:space-between;align-items:flex-end;gap:10px;
      pointer-events:none;
    }
    .joyWrap, .fireWrap{pointer-events:auto}
    .joyWrap{
      width:140px;height:140px;position:relative;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      backdrop-filter: blur(6px);
    }
    .joyBase{
      position:absolute;inset:20px;
      border-radius:999px;
      border:1px dashed rgba(255,255,255,.20);
    }
    .joyKnob{
      position:absolute;left:50%;top:50%;
      width:54px;height:54px;margin:-27px 0 0 -27px;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(242,227,0,.45), rgba(47,127,47,.35));
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 10px 25px rgba(0,0,0,.35);
    }
    .fireBtn{
      width:140px;height:140px;
      border-radius:18px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
    }
    .fireBtnInner{
      width:86px;height:86px;border-radius:999px;
      background:linear-gradient(180deg, rgba(198,0,24,.55), rgba(198,0,24,.20));
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 10px 25px rgba(0,0,0,.35);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      letter-spacing:.5px;
    }

    @media (min-width: 900px){
      #touchUI{display:none}
    }
  </style>
</head>

<body>
<div id="wrap">
  <header>
    <div class="title">
      <div class="pixel">Aromat Game!</div>
      <div class="sub">Spara l’Aromat sulla pizza. Bonus berretti = x10.</div>
    </div>
    <div class="controls">
      <button id="audioBtn" class="btn-audio">Audio: ON</button>
      <span class="chip">Touch ok ✅</span>
    </div>
  </header>

  <main>
    <div class="frame">
      <div id="hud">
        <div class="left">
          <div class="stat">Tempo: <b id="timeLbl">--</b></div>
          <div class="stat">Punti: <b id="scoreLbl">0</b></div>
          <div class="stat">Colpi: <b id="ammoLbl">0</b></div>
          <div class="stat">Moltiplicatore: <b id="multLbl">x1</b></div>
        </div>
        <div class="right">
          <div class="stat">Best: <b id="bestLbl">0</b></div>
        </div>
      </div>

      <canvas id="game" width="1280" height="720"></canvas>

      <div id="overlay">
        <!-- Start panel -->
        <div id="startPanel" class="panel">
          <h2>Seleziona durata</h2>
          <p>Muovi il barattolo con il joystick (o WASD). Tappa/spara. Prendi i berretti per <b>x10</b> e +5 colpi.</p>
          <div class="row">
            <button class="big grow btn-yellow" data-time="15">15 secondi</button>
            <button class="big grow btn-yellow" data-time="30">30 secondi</button>
            <button class="big grow btn-yellow" data-time="60">1 minuto</button>
          </div>
          <div class="hint">Nota: su mobile l’audio può partire al primo tap (colpa dei browser, non mia).</div>
        </div>

        <!-- End banner -->
        <div id="endPanel" class="panel hidden">
          <h2>Fine gioco</h2>
          <p>Punti finali: <b id="finalScore">0</b> · Best: <b id="finalBest">0</b></p>
          <div class="row">
            <button id="restartBtn" class="big grow btn-yellow">Restart</button>
            <button id="backBtn" class="big grow danger">Menu</button>
          </div>
          <div class="hint">Banner di fine gioco: presente. Umani: felici.</div>
        </div>
      </div>

      <!-- Touch UI -->
      <div id="touchUI">
        <div class="joyWrap" id="joy">
          <div class="joyBase"></div>
          <div class="joyKnob" id="knob"></div>
        </div>
        <div class="fireWrap">
          <div class="fireBtn" id="fire">
            <div class="fireBtnInner">FIRE</div>
          </div>
        </div>
      </div>

      <!-- Audio -->
      <audio id="bgMusic" src="8bit.mp3" loop preload="auto"></audio>
    </div>
  </main>
</div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // UI
  const timeLbl = document.getElementById('timeLbl');
  const scoreLbl = document.getElementById('scoreLbl');
  const ammoLbl = document.getElementById('ammoLbl');
  const multLbl = document.getElementById('multLbl');
  const bestLbl = document.getElementById('bestLbl');

  const startPanel = document.getElementById('startPanel');
  const endPanel = document.getElementById('endPanel');
  const finalScore = document.getElementById('finalScore');
  const finalBest = document.getElementById('finalBest');
  const restartBtn = document.getElementById('restartBtn');
  const backBtn = document.getElementById('backBtn');

  const audioBtn = document.getElementById('audioBtn');
  const music = document.getElementById('bgMusic');

  // Touch controls
  const joy = document.getElementById('joy');
  const knob = document.getElementById('knob');
  const fire = document.getElementById('fire');

  // Storage
  const BEST_KEY = 'aromat_best_v3';
  let best = Number(localStorage.getItem(BEST_KEY) || 0);
  bestLbl.textContent = best;

  // Audio logic (best effort autoplay)
  let audioEnabled = true;
  music.volume = 0.30;

  function tryPlayAudio() {
    if (!audioEnabled) return;
    const p = music.play();
    if (p && typeof p.catch === 'function') {
      p.catch(() => {
        // Autoplay blocked: we'll resume on first user gesture.
      });
    }
  }
  // Try immediately
  tryPlayAudio();
  // Also try on first interaction (covers iOS/Android autoplay policies)
  window.addEventListener('pointerdown', () => tryPlayAudio(), { once: true, passive: true });

  function setAudioUI() {
    audioBtn.textContent = `Audio: ${audioEnabled ? 'ON' : 'OFF'}`;
    audioBtn.classList.toggle('off', !audioEnabled);
  }
  setAudioUI();

  audioBtn.addEventListener('click', () => {
    audioEnabled = !audioEnabled;
    if (!audioEnabled) {
      music.pause();
    } else {
      tryPlayAudio();
    }
    setAudioUI();
  });

  // Game state
  let running = false;
  let duration = 30;
  let timeLeft = 0;
  let score = 0;
  let ammo = 0;
  let mult = 1;
  let multTimer = 0;

  // Player (Aromat shaker)
  const player = {
    x: canvas.width * 0.2,
    y: canvas.height * 0.65,
    r: 34,
    vx: 0,
    vy: 0,
    speed: 520,
    aimX: 1,
    aimY: 0,
  };

  // Pizza target
  const pizza = {
    x: canvas.width * 0.75,
    y: canvas.height * 0.52,
    r: 160,
    health: 1.0, // 1 -> never reaches 0
    wobble: 0,
    crumbs: [],
  };

  // Projectiles (Aromat shots)
  const shots = [];

  // Falling berets bonus
  const hats = [];
  let hatSpawnTimer = 0;

  // Snow (Aromat grains)
  const snow = [];
  const SNOW_COUNT = 140;

  function rand(min, max) { return Math.random() * (max - min) + min; }
  function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

  // Setup snow
  for (let i = 0; i < SNOW_COUNT; i++) {
    snow.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      s: rand(0.6, 2.2),
      vy: rand(25, 90),
      drift: rand(-18, 18),
      a: rand(0.25, 0.75),
    });
  }

  // Input (keyboard)
  const keys = new Set();
  window.addEventListener('keydown', (e) => {
    keys.add(e.key.toLowerCase());
    if ([' ', 'arrowup','arrowdown','arrowleft','arrowright'].includes(e.key.toLowerCase())) e.preventDefault();
  });
  window.addEventListener('keyup', (e) => keys.delete(e.key.toLowerCase()));

  // Pointer aim + shoot
  let pointerDown = false;
  canvas.addEventListener('pointerdown', (e) => {
    pointerDown = true;
    canvas.setPointerCapture(e.pointerId);
    // shoot on tap
    shoot();
  }, { passive: false });
  canvas.addEventListener('pointerup', () => pointerDown = false);

  canvas.addEventListener('pointermove', (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
    const my = (e.clientY - rect.top) * (canvas.height / rect.height);
    const dx = mx - player.x;
    const dy = my - player.y;
    const len = Math.hypot(dx, dy) || 1;
    player.aimX = dx / len;
    player.aimY = dy / len;
  });

  // Touch joystick
  let joyActive = false;
  let joyId = null;
  let joyCenter = { x: 0, y: 0 };
  let joyVec = { x: 0, y: 0 };

  function setKnob(x, y) {
    knob.style.left = `${x}px`;
    knob.style.top = `${y}px`;
  }

  function resetJoy() {
    joyActive = false;
    joyId = null;
    joyVec.x = 0; joyVec.y = 0;
    setKnob(70, 70);
  }
  setKnob(70, 70);

  joy.addEventListener('pointerdown', (e) => {
    joyActive = true;
    joyId = e.pointerId;
    joy.setPointerCapture(joyId);
    const r = joy.getBoundingClientRect();
    joyCenter.x = r.left + r.width / 2;
    joyCenter.y = r.top + r.height / 2;
  });

  joy.addEventListener('pointermove', (e) => {
    if (!joyActive || e.pointerId !== joyId) return;
    const r = joy.getBoundingClientRect();
    const max = 44;
    const dx = e.clientX - joyCenter.x;
    const dy = e.clientY - joyCenter.y;
    const len = Math.hypot(dx, dy) || 1;
    const ndx = (dx / len) * Math.min(max, len);
    const ndy = (dy / len) * Math.min(max, len);
    joyVec.x = ndx / max;
    joyVec.y = ndy / max;
    setKnob(70 + ndx, 70 + ndy);
    // set aim same direction as move if no pointer aim
    if (Math.abs(joyVec.x) + Math.abs(joyVec.y) > 0.1) {
      const alen = Math.hypot(joyVec.x, joyVec.y) || 1;
      player.aimX = joyVec.x / alen;
      player.aimY = joyVec.y / alen;
    }
  });

  joy.addEventListener('pointerup', (e) => {
    if (e.pointerId !== joyId) return;
    resetJoy();
  });
  joy.addEventListener('pointercancel', resetJoy);

  // Fire button
  fire.addEventListener('pointerdown', () => shoot());

  // Buttons durations
  startPanel.querySelectorAll('button[data-time]').forEach(btn => {
    btn.addEventListener('click', () => {
      duration = Number(btn.dataset.time);
      startGame();
    });
  });

  restartBtn.addEventListener('click', () => {
    startGame();
  });

  backBtn.addEventListener('click', () => {
    running = false;
    endPanel.classList.add('hidden');
    startPanel.classList.remove('hidden');
    timeLbl.textContent = '--';
    scoreLbl.textContent = '0';
    ammoLbl.textContent = '0';
    multLbl.textContent = 'x1';
  });

  function startGame() {
    // reset
    running = true;
    startPanel.classList.add('hidden');
    endPanel.classList.add('hidden');

    timeLeft = duration;
    score = 0;
    ammo = Math.round(duration * 2.2); // feels nice
    mult = 1;
    multTimer = 0;

    player.x = canvas.width * 0.2;
    player.y = canvas.height * 0.65;
    player.vx = player.vy = 0;
    player.aimX = 1; player.aimY = 0;

    pizza.health = 1.0;
    pizza.crumbs.length = 0;
    pizza.wobble = 0;

    shots.length = 0;
    hats.length = 0;
    hatSpawnTimer = 0;

    updateHUD();

    // start music ASAP
    tryPlayAudio();
  }

  function endGame() {
    running = false;

    if (score > best) {
      best = score;
      localStorage.setItem(BEST_KEY, String(best));
    }
    bestLbl.textContent = best;
    finalScore.textContent = score;
    finalBest.textContent = best;

    endPanel.classList.remove('hidden');
  }

  function updateHUD() {
    timeLbl.textContent = `${timeLeft.toFixed(1)}s`;
    scoreLbl.textContent = score;
    ammoLbl.textContent = ammo;
    multLbl.textContent = `x${mult}`;
  }

  function shoot() {
    if (!running) return;
    if (ammo <= 0) return;
    ammo--;

    const spd = 900;
    shots.push({
      x: player.x + player.aimX * (player.r + 8),
      y: player.y + player.aimY * (player.r + 8),
      vx: player.aimX * spd,
      vy: player.aimY * spd,
      r: 6,
      life: 1.2
    });
  }

  function spawnHat() {
    // Beret Aromat colors
    const colors = ['#f2e300', '#2f7f2f', '#c60018'];
    const c = colors[Math.floor(Math.random()*colors.length)];
    hats.push({
      x: rand(canvas.width*0.45, canvas.width*0.95),
      y: -30,
      vy: rand(120, 210),
      r: rand(18, 26),
      c,
      wob: rand(0, Math.PI*2)
    });
  }

  function hitPizza() {
    // Points
    score += 10 * mult;

    // pizza never fully dies, but crumbs increase
    pizza.health = clamp(pizza.health - 0.02, 0.22, 1.0);
    pizza.wobble = 0.22;

    // Add crumbs particles
    const pieces = Math.floor(rand(4, 8));
    for (let i=0;i<pieces;i++){
      const ang = rand(0, Math.PI*2);
      const rr = pizza.r * rand(0.35, 0.98);
      pizza.crumbs.push({
        x: pizza.x + Math.cos(ang)*rr,
        y: pizza.y + Math.sin(ang)*rr,
        vx: Math.cos(ang)*rand(60, 240),
        vy: Math.sin(ang)*rand(60, 240) - rand(30,120),
        r: rand(2.5, 6.5),
        a: 1,
        t: rand(0,1),
      });
    }
  }

  function collectHat(i) {
    hats.splice(i,1);
    ammo += 5;
    mult = 10;
    multTimer = 6.0; // seconds
  }

  // Draw helpers
  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function drawBackground() {
    // subtle scanlines
    ctx.save();
    for(let y=0;y<canvas.height;y+=4){
      ctx.globalAlpha = 0.04;
      ctx.fillStyle = '#000';
      ctx.fillRect(0,y,canvas.width,1);
    }
    ctx.restore();
  }

  function drawSnow(dt){
    ctx.save();
    for(const s of snow){
      s.y += s.vy*dt;
      s.x += s.drift*dt;
      if (s.y > canvas.height+10){ s.y = -10; s.x = Math.random()*canvas.width; }
      if (s.x < -10) s.x = canvas.width+10;
      if (s.x > canvas.width+10) s.x = -10;
      ctx.globalAlpha = s.a;
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.s,0,Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  function drawPizza() {
    const wob = pizza.wobble;
    const wobX = Math.sin(perf*6) * wob * 8;
    const wobY = Math.cos(perf*7) * wob * 6;

    // Base crust
    const baseR = pizza.r;
    const innerR = baseR * 0.86;

    ctx.save();
    ctx.translate(wobX, wobY);

    // crust
    ctx.fillStyle = '#d8a25a';
    ctx.beginPath();
    ctx.arc(pizza.x, pizza.y, baseR, 0, Math.PI*2);
    ctx.fill();

    // sauce/cheese layer with "disintegration": shrink slightly with health but never zero
    const layerR = innerR * (0.78 + pizza.health*0.22);
    ctx.fillStyle = '#f3c65a';
    ctx.beginPath();
    ctx.arc(pizza.x, pizza.y, layerR, 0, Math.PI*2);
    ctx.fill();

    // cheese bubbles
    ctx.globalAlpha = 0.85;
    for(let i=0;i<16;i++){
      const ang = i*(Math.PI*2/16) + perf*0.15;
      const rr = layerR*rand(0.10, 0.95);
      const x = pizza.x + Math.cos(ang)*rr;
      const y = pizza.y + Math.sin(ang)*rr;
      ctx.fillStyle = (i%3===0) ? '#ffd77a' : '#f7d06b';
      ctx.beginPath();
      ctx.arc(x,y, rand(6,14), 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // pepperoni-ish dots (retro)
    ctx.fillStyle = '#c24a3a';
    for(let i=0;i<10;i++){
      const ang = i*(Math.PI*2/10) + perf*0.07;
      const rr = layerR*0.55;
      const x = pizza.x + Math.cos(ang)*rr;
      const y = pizza.y + Math.sin(ang)*rr;
      ctx.beginPath();
      ctx.arc(x,y, 18*(0.75+pizza.health*0.25), 0, Math.PI*2);
      ctx.fill();
    }

    // crumbs particles
    for (const c of pizza.crumbs){
      ctx.globalAlpha = c.a;
      ctx.fillStyle = (c.r > 5) ? '#d8a25a' : '#f3c65a';
      ctx.beginPath();
      ctx.arc(c.x,c.y,c.r,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    ctx.restore();
  }

  function drawPlayer() {
    // Jar body
    const x = player.x, y = player.y;
    const w = 70, h = 120;
    const rx = x - w/2, ry = y - h/2;

    // shadow
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.ellipse(x, y + h/2 - 8, 38, 12, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // body
    ctx.fillStyle = '#f2e300';
    roundRect(rx, ry, w, h, 16);
    ctx.fill();

    // green label
    ctx.fillStyle = '#2f7f2f';
    roundRect(rx+8, ry+42, w-16, 40, 12);
    ctx.fill();

    // red cap
    ctx.fillStyle = '#c60018';
    roundRect(rx+8, ry+6, w-16, 22, 10);
    ctx.fill();

    // "Aromat" text centered
    ctx.fillStyle = '#fff';
    ctx.font = '900 18px ui-monospace, monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Aromat', x, ry+62);

    // aim line
    ctx.globalAlpha = 0.25;
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x + player.aimX*70, y + player.aimY*70);
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  function drawShots() {
    for (const s of shots){
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fill();
      // tiny trail
      ctx.globalAlpha = 0.25;
      ctx.beginPath();
      ctx.arc(s.x - s.vx*0.012, s.y - s.vy*0.012, s.r*1.8, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  function drawHats() {
    for (const h of hats){
      // little beret-like shape
      ctx.save();
      ctx.translate(h.x, h.y);
      ctx.rotate(Math.sin(perf*2 + h.wob) * 0.06);
      ctx.fillStyle = h.c;
      ctx.beginPath();
      ctx.ellipse(0, 0, h.r*1.2, h.r*0.8, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = 'rgba(0,0,0,.18)';
      ctx.beginPath();
      ctx.ellipse(0, h.r*0.25, h.r*0.9, h.r*0.45, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
  }

  // Timing
  let last = performance.now();
  let perf = 0;

  function tick(now){
    const dt = Math.min(0.033, (now - last) / 1000);
    last = now;
    perf += dt;

    // update
    if (running){
      timeLeft -= dt;
      if (timeLeft <= 0){
        timeLeft = 0;
        updateHUD();
        endGame();
      }
    }

    // multiplier timer
    if (multTimer > 0){
      multTimer -= dt;
      if (multTimer <= 0){
        mult = 1;
        multTimer = 0;
      }
    }

    // movement
    const mx = (keys.has('a') || keys.has('arrowleft') ? -1 : 0) + (keys.has('d') || keys.has('arrowright') ? 1 : 0);
    const my = (keys.has('w') || keys.has('arrowup') ? -1 : 0) + (keys.has('s') || keys.has('arrowdown') ? 1 : 0);

    const vx = mx + joyVec.x;
    const vy = my + joyVec.y;
    const len = Math.hypot(vx, vy) || 1;
    const moveX = (Math.abs(vx) > 0.02) ? (vx / len) : 0;
    const moveY = (Math.abs(vy) > 0.02) ? (vy / len) : 0;

    player.x += moveX * player.speed * dt;
    player.y += moveY * player.speed * dt;

    // bounds
    player.x = clamp(player.x, player.r + 8, canvas.width - player.r - 8);
    player.y = clamp(player.y, player.r + 8, canvas.height - player.r - 8);

    // update shots
    for (let i = shots.length-1; i>=0; i--){
      const s = shots[i];
      s.x += s.vx*dt;
      s.y += s.vy*dt;
      s.life -= dt;

      // collision with pizza
      const dx = s.x - pizza.x;
      const dy = s.y - pizza.y;
      const d = Math.hypot(dx, dy);
      if (d < pizza.r * 0.92){
        shots.splice(i,1);
        if (running) hitPizza();
        continue;
      }

      if (s.life <= 0 || s.x < -50 || s.x > canvas.width+50 || s.y < -50 || s.y > canvas.height+50){
        shots.splice(i,1);
      }
    }

    // pizza wobble decay
    pizza.wobble = Math.max(0, pizza.wobble - dt*0.8);

    // crumbs update
    for (let i = pizza.crumbs.length-1; i>=0; i--){
      const c = pizza.crumbs[i];
      c.vy += 420*dt;
      c.x += c.vx*dt;
      c.y += c.vy*dt;
      c.a -= dt*0.55;
      if (c.a <= 0) pizza.crumbs.splice(i,1);
    }

    // hats
    if (running){
      hatSpawnTimer -= dt;
      if (hatSpawnTimer <= 0){
        hatSpawnTimer = rand(3.5, 6.0);
        spawnHat();
      }
    }

    for (let i = hats.length-1; i>=0; i--){
      const h = hats[i];
      h.y += h.vy*dt;
      h.x += Math.sin(perf*1.7 + h.wob)*dt*22;

      // collect
      const dx = h.x - player.x;
      const dy = h.y - player.y;
      if (Math.hypot(dx,dy) < (h.r + player.r*0.65)){
        collectHat(i);
        continue;
      }

      // offscreen
      if (h.y > canvas.height + 60){
        hats.splice(i,1);
      }
    }

    if (running) updateHUD();

    // render
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBackground();
    drawSnow(dt);
    drawPizza();
    drawHats();
    drawShots();
    drawPlayer();

    // info when not running
    if (!running && startPanel.classList.contains('hidden') && endPanel.classList.contains('hidden')) {
      // no-op
    }

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

})();
</script>
</body>
</html>
