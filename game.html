<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Aromat Game</title>

<style>
body{
  margin:0;
  background:#070b18;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  font-family: monospace;
  color:#c7d2fe;
  touch-action:none;
}
.wrap{
  background:#0f1629;
  border:3px solid #2a3350;
  padding:12px;
  box-shadow:0 0 0 4px #050712;
  position:relative;
  width:min(96vw,460px);
}
canvas{
  width:100%;
  image-rendering:pixelated;
  border:2px solid #2a3350;
  background:#050712;
  touch-action:none;
}
.hud{
  display:flex;
  justify-content:space-between;
  gap:10px;
  margin:6px 0 6px;
  font-size:14px;
  flex-wrap:wrap;
}
.hud b{color:#facc15}

.title{
  text-align:center;
  margin-bottom:6px;
  color:#facc15;
  text-shadow: 0 0 6px #facc15, 0 0 12px #facc15;
}
.subtitle{
  font-size:12px;
  color:#c7d2fe;
}

.modes{
  display:flex;
  gap:8px;
  justify-content:center;
  margin:6px 0 4px;
}
.modes button{
  padding:8px 10px;
  font-size:14px;
  background:#111a33;
  border:2px solid #2a3350;
  color:#fff;
  cursor:pointer;
}
.modes button.active{
  border-color:#facc15;
  box-shadow:0 0 0 2px rgba(250,204,21,0.25) inset;
}

.start{
  margin-top:6px;
  width:100%;
  padding:14px;
  font-size:22px;
  font-weight:bold;
  background:#111a33;
  color:#facc15;
  border:3px solid #facc15;
  cursor:pointer;
}
.start.blink{
  animation: blink 1s infinite;
}
@keyframes blink{
  0%,50%{opacity:1}
  51%,100%{opacity:0.3}
}

.controls{
  margin-top:6px;
  display:flex;
  gap:6px;
}
.controls button{
  flex:1;
  padding:10px;
  font-size:16px;
  background:#111a33;
  border:2px solid #2a3350;
  color:#fff;
}
.controls button:active{
  transform:translateY(1px);
}

/* BANNER FINALE */
.banner{
  position:absolute;
  inset:0;
  background:rgba(5,7,18,0.92);
  display:none;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:10px;
}
.banner.show{display:flex}
.banner .box{
  border:3px solid #facc15;
  padding:16px;
  background:#0f1629;
  box-shadow:0 0 0 4px #050712;
  max-width: 420px;
}
.banner h1{
  margin:0 0 8px;
  color:#facc15;
}
.banner .small{
  margin-top:8px;
  color:#c7d2fe;
  font-size:12px;
}
.restart{
  margin-top:14px;
  padding:12px 18px;
  font-size:18px;
  font-weight:bold;
  background:#111a33;
  color:#facc15;
  border:3px solid #facc15;
  cursor:pointer;
}
.restart:active{
  transform:translateY(1px);
}
</style>
</head>

<body>
<div class="wrap">

  <div class="title">
    <div>AROMAT GAME!</div>
    <div class="subtitle">Spara l’aromat sulla pizza</div>
  </div>

  <div class="modes" id="modes">
    <button data-sec="15" class="active">15s</button>
    <button data-sec="30">30s</button>
    <button data-sec="60">1 min</button>
  </div>

  <div class="hud">
    <div>Score <b id="score">0</b></div>
    <div>Tempo <b id="time">15</b>s</div>
    <div>Berrette <b id="ammo">0</b></div>
    <div>Moltiplicatore <b id="mult">x1</b></div>
  </div>

  <canvas id="game" width="320" height="180"></canvas>

  <button id="start" class="start blink">START</button>

  <div class="controls">
    <button id="left">◀</button>
    <button id="fire">SPARA</button>
    <button id="right">▶</button>
  </div>

  <div id="banner" class="banner">
    <div class="box">
      <h1>COMPLIMENTI!</h1>
      <div>Hai vinto l’opportunità di pagarmi da bere!!</div>
      <div class="small">Score finale: <b id="finalScore">0</b></div>
      <button id="restartBtn" class="restart">RESTART</button>
    </div>
  </div>

</div>

<script>
const c=document.getElementById("game");
const ctx=c.getContext("2d", { alpha:false });
const W=c.width,H=c.height;

let running=false;
let score=0;
let timeLeft=15;
let durationSec=15;
let timerId=null;

const scoreEl=document.getElementById("score");
const timeEl=document.getElementById("time");
const ammoEl=document.getElementById("ammo");
const multEl=document.getElementById("mult");
const startBtn=document.getElementById("start");
const banner=document.getElementById("banner");
const finalScoreEl=document.getElementById("finalScore");
const restartBtn=document.getElementById("restartBtn");

const player={x:160,y:150,w:26,h:36,cooldown:0};
const bullets=[];
const grains=[];      // neve aromat
const pizzaBits=[];   // pezzi che volano via
const bonuses=[];     // berretti bonus

const pizza={
  x:160,y:60,r:22,vx:1.55,
  health:1.0
};

const MIN_HEALTH = 0.30;  // non scende mai sotto
const HIT_DECAY  = 0.045; // quanto perde a colpo
const BASE_POINTS = 10;

let hatAmmo = 0; // colpi "berrette"

// ===== PIXEL TEXT =====
function pixelText(txt,x,y,color){
  const map={
    A:["0110","1001","1111","1001","1001"],
    R:["1110","1001","1110","1010","1001"],
    O:["0110","1001","1001","1001","0110"],
    M:["1001","1111","1111","1001","1001"],
    T:["1111","0010","0010","0010","0010"]
  };
  ctx.fillStyle=color;
  let cx=x|0;
  for(const ch of txt){
    const g=map[ch];
    if(!g){ cx += 6; continue; }
    for(let r=0;r<g.length;r++){
      for(let col=0;col<g[r].length;col++){
        if(g[r][col]==="1") ctx.fillRect(cx+col, (y+r)|0, 1, 1);
      }
    }
    cx += 6;
  }
}
function pixelTextWidth(txt){ return txt.length * 6; }

// ===== DRAW =====
function drawAromat(){
  const l=(player.x-player.w/2)|0;
  const t=(player.y-player.h/2)|0;

  ctx.fillStyle="#f6d32d";
  ctx.fillRect(l,t+6,player.w,player.h-6);

  ctx.fillStyle="#d3181c";
  ctx.fillRect(l+2,t,player.w-4,7);

  ctx.fillStyle="#12a14a";
  ctx.fillRect(l+1,t+18,player.w-2,14);

  const txt="AROMAT";
  const tw=pixelTextWidth(txt);
  const tx = (l + ((player.w - tw)/2))|0;
  const ty = (t + 22)|0;
  pixelText(txt,tx,ty,"#fff");
}

function drawPizza(){
  const h = pizza.health;

  ctx.fillStyle = "#c96b2b";
  ctx.beginPath(); ctx.arc(pizza.x,pizza.y,pizza.r+5,0,Math.PI*2); ctx.fill();

  const cheese = Math.floor(230*h + 40);
  ctx.fillStyle = `rgb(${cheese},${cheese-10},${Math.floor(140*h+60)})`;
  ctx.beginPath(); ctx.arc(pizza.x,pizza.y,pizza.r+1,0,Math.PI*2); ctx.fill();

  ctx.fillStyle = `rgb(${Math.floor(190*h+40)},70,70)`;
  for(let i=0;i<7;i++){
    const a = i*(Math.PI*2/7) + 0.3;
    const rr = pizza.r*0.55;
    ctx.beginPath();
    ctx.arc(pizza.x + Math.cos(a)*rr, pizza.y + Math.sin(a)*rr*0.75, 3, 0, Math.PI*2);
    ctx.fill();
  }

  ctx.fillStyle = `rgb(${Math.floor(170*h+50)},60,60)`;
  for(let i=0;i<5;i++){
    const a = i*(Math.PI*2/5) + 0.6;
    const rr = pizza.r*0.35;
    const px = (pizza.x + Math.cos(a)*rr)|0;
    const py = (pizza.y + Math.sin(a)*rr)|0;
    ctx.fillRect(px-2, py-2, 5, 5);
    ctx.fillStyle = `rgba(255,200,200,${0.35*h})`;
    ctx.fillRect(px, py, 1, 1);
    ctx.fillStyle = `rgb(${Math.floor(170*h+50)},60,60)`;
  }

  ctx.strokeStyle = `rgba(255,180,80,${0.7*h})`;
  ctx.lineWidth = 1;
  for(let i=0;i<4;i++){
    const a=i*(Math.PI/2);
    ctx.beginPath();
    ctx.moveTo(pizza.x,pizza.y);
    ctx.lineTo(pizza.x + Math.cos(a)*(pizza.r+5), pizza.y + Math.sin(a)*(pizza.r+5));
    ctx.stroke();
  }
}

function drawHatBonus(b){
  const x=b.x|0, y=b.y|0;
  ctx.fillStyle=b.c1;
  ctx.fillRect(x-3,y-3,7,3);
  ctx.fillStyle=b.c2;
  ctx.fillRect(x-4,y,9,3);
  ctx.fillStyle="#ffffff";
  ctx.fillRect(x-1,y-2,2,1);
}

function drawHatBullet(b){
  const x=b.x|0, y=b.y|0;
  ctx.fillStyle=b.c1;
  ctx.fillRect(x-3,y-2,7,2);
  ctx.fillStyle=b.c2;
  ctx.fillRect(x-4,y,9,3);
  ctx.fillStyle="#ffffff";
  ctx.fillRect(x-1,y-1,2,1);
}

// ===== GAME =====
function currentMultiplier(){ return hatAmmo > 0 ? 10 : 1; }

function shoot(){
  if(player.cooldown>0 || !running) return;

  const isHat = hatAmmo > 0;

  if(isHat){
    hatAmmo--;
    ammoEl.textContent = hatAmmo;
    bullets.push({
      x:player.x, y:player.y-20, vy:-4.3,
      hat:true, c1:"#d3181c", c2:"#12a14a"
    });
  }else{
    bullets.push({ x:player.x, y:player.y-20, vy:-4, hat:false });
  }

  player.cooldown = 8;
  multEl.textContent = "x"+currentMultiplier();
}

function spawnGrain(){
  grains.push({ x:Math.random()*W, y:-2, vy:0.6+Math.random()*1.2 });
}

function spawnHatBonus(){
  const palette = [
    {c1:"#d3181c", c2:"#12a14a"},
    {c1:"#f6d32d", c2:"#12a14a"},
    {c1:"#d3181c", c2:"#f6d32d"}
  ];
  const p = palette[(Math.random()*palette.length)|0];
  bonuses.push({
    x: 16 + Math.random()*(W-32),
    y: -10,
    vy: 0.9 + Math.random()*0.9,
    c1: p.c1, c2: p.c2
  });
}

function addPizzaBits(hitX, hitY){
  const count = 6 + ((Math.random()*5)|0);
  for(let i=0;i<count;i++){
    pizzaBits.push({
      x: hitX, y: hitY,
      vx: (Math.random()-0.5)*2.6,
      vy: -1.2 - Math.random()*1.6,
      life: 40 + ((Math.random()*30)|0),
      s: 1 + ((Math.random()*2)|0),
      col: Math.random()<0.5 ? "#fef3c7" : "#c96b2b"
    });
  }
}

function update(){
  if(!running) return;

  player.cooldown = Math.max(0, player.cooldown-1);

  pizza.x += pizza.vx;
  if(pizza.x < 46 || pizza.x > 274) pizza.vx *= -1;

  for(const b of bullets) b.y += b.vy;

  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    if(Math.hypot(b.x-pizza.x, b.y-pizza.y) < pizza.r){
      bullets.splice(i,1);

      const mult = currentMultiplier();
      score += BASE_POINTS * mult;
      scoreEl.textContent = score;

      pizza.health = Math.max(MIN_HEALTH, pizza.health - HIT_DECAY);
      addPizzaBits(b.x, b.y);
      continue;
    }
    if(b.y < -10) bullets.splice(i,1);
  }

  if(Math.random() < 0.55) spawnGrain();
  for(const g of grains) g.y += g.vy;
  for(let i=grains.length-1;i>=0;i--) if(grains[i].y > H) grains.splice(i,1);

  for(const p of pizzaBits){
    p.x += p.vx; p.y += p.vy;
    p.vy += 0.08;
    p.life--;
  }
  for(let i=pizzaBits.length-1;i>=0;i--) if(pizzaBits[i].life <= 0) pizzaBits.splice(i,1);

  if(Math.random() < 0.012) spawnHatBonus();
  for(const b of bonuses) b.y += b.vy;

  for(let i=bonuses.length-1;i>=0;i--){
    const b=bonuses[i];
    const dx = Math.abs(b.x - player.x);
    const dy = Math.abs(b.y - player.y);
    if(dx < 16 && dy < 20){
      bonuses.splice(i,1);
      hatAmmo += 5;
      ammoEl.textContent = hatAmmo;
      multEl.textContent = "x"+currentMultiplier();
      continue;
    }
    if(b.y > H+10) bonuses.splice(i,1);
  }

  multEl.textContent = "x"+currentMultiplier();
}

function render(){
  ctx.fillStyle="#050712";
  ctx.fillRect(0,0,W,H);

  drawPizza();

  for(const p of pizzaBits){
    ctx.fillStyle = p.col;
    ctx.fillRect(p.x|0, p.y|0, p.s, p.s);
  }

  drawAromat();

  for(const b of bullets){
    if(b.hat) drawHatBullet(b);
    else{
      ctx.fillStyle="#facc15";
      ctx.fillRect((b.x|0), (b.y|0), 2, 4);
    }
  }

  ctx.fillStyle="#fde68a";
  for(const g of grains) ctx.fillRect(g.x|0, g.y|0, 1, 1);

  for(const b of bonuses) drawHatBonus(b);
}

function loop(){
  update();
  render();
  if(running) requestAnimationFrame(loop);
}

// ===== TIMER =====
function startTimer(){
  timeLeft = durationSec;
  timeEl.textContent = timeLeft;

  clearInterval(timerId);
  timerId = setInterval(()=>{
    if(!running){ clearInterval(timerId); return; }
    timeLeft--;
    timeEl.textContent = timeLeft;
    if(timeLeft<=0){
      running=false;
      finalScoreEl.textContent = score;
      banner.classList.add("show");
      startBtn.classList.add("blink");
      clearInterval(timerId);
    }
  }, 1000);
}

// ===== START / RESTART =====
function startGame(){
  score=0;
  scoreEl.textContent=0;

  bullets.length=0;
  grains.length=0;
  pizzaBits.length=0;
  bonuses.length=0;

  hatAmmo=0;
  ammoEl.textContent=0;
  multEl.textContent="x1";

  pizza.health=1.0;
  pizza.x=160;

  banner.classList.remove("show");
  running=true;
  startBtn.classList.remove("blink");
  startTimer();
  loop();
}

// ===== MODES =====
const modes = document.getElementById("modes");
modes.addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-sec]");
  if(!btn) return;
  if(running) return;

  for(const b of modes.querySelectorAll("button")) b.classList.remove("active");
  btn.classList.add("active");

  durationSec = parseInt(btn.dataset.sec,10);
  timeLeft = durationSec;
  timeEl.textContent = timeLeft;
});

// ===== TOUCH (stabile) =====
let dragId=null, dragStartX=0, playerStartX=0;

c.addEventListener("pointerdown",(e)=>{
  c.setPointerCapture(e.pointerId);
  if(dragId===null){
    dragId=e.pointerId;
    dragStartX=e.clientX;
    playerStartX=player.x;
  }else{
    shoot();
  }
});

c.addEventListener("pointermove",(e)=>{
  if(e.pointerId!==dragId || !running) return;
  const r=c.getBoundingClientRect();
  const dx=(e.clientX-dragStartX)*(W/r.width);
  player.x=Math.max(20,Math.min(300,playerStartX+dx));
});

c.addEventListener("pointerup",(e)=>{
  if(e.pointerId===dragId){
    shoot();
    dragId=null;
  }
});

// fallback buttons
document.getElementById("left").onpointerdown=()=>player.x=Math.max(20,player.x-10);
document.getElementById("right").onpointerdown=()=>player.x=Math.min(300,player.x+10);
document.getElementById("fire").onpointerdown=shoot;

// start / restart
startBtn.onclick=()=>{ if(!running) startGame(); };
restartBtn.onclick=()=>{ if(!running) startGame(); };
</script>
</body>
</html>
